<!DOCTYPE html>
<html>
  <head>
    <title>Vassar College Cognitive Science</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <link rel="stylesheet" href="style.css" type="text/css">
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" type="image/png" href="VC_logo.png"/>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.3"></script>
  </head>
  <body>
    <div id="header">
      <div id="logo-wrapper">
        <img src="VC_logo.png" alt="Vassar Logo" id="vclogo">
        <h3 id="logotext">Vassar College Cognitive Science</h3>
      </div>
    </div>
    <div id="jspsych-target"></div>
  </body>
  <script>

    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      show_progress_bar: true,
      auto_update_progress_bar: false,
      message_progress_bar: 'Trials completed:',
      on_finish: function() {
        // Display data
        jsPsych.data.displayData();
        // window.location = "https://app.prolific.com/submissions/complete?cc=C1AN17T8";
      }
    });

    // Capture info from Prolific
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

    // DataPipe info
    const filename = `${subject_id}.csv`;

    jsPsych.data.addProperties({
      subject_id: subject_id,
      study_id: study_id,
      session_id: session_id
    });


    const condition = await jsPsychPipe.getCondition(experiment_id)

    var timeline = [];

  // CONDITION ASSIGNMENTS
    var possible_alignments = [
      'control',
      'control',
      // 'm1boost_m2control_5dB',
      // 'm1boost_m2control_8dB',
      'm1boost_m2cut_5dB',
      'm1boost_m2cut_8dB',
      // 'm1control_m2boost_5dB',
      // 'm1control_m2boost_8dB',
      // 'm1control_m2cut_5dB',
      // 'm1control_m2cut_8dB',
      'm1cut_m2boost_5dB',
      'm1cut_m2boost_8dB',
      // 'm1cut_m2control_5dB',
      // 'm1cut_m2control_8dB',
      'mirrored_5dB',
      'mirrored_8dB',
    ];
                            
                          
    var possible_instruments = ["2_two_instr_norm", "3_one_extra_norm", "4_two_extra_norm", "5_three_extra_norm"]

    var eq_assignments = jsPsych.randomization.sampleWithReplacement(possible_alignments, 12)
    var song_order_options = [[0,1,2],[0,2,1],[1,2,0],[1,0,2],[2,1,0],[2,0,1]]
    var instr_order = [jsPsych.randomization.sampleWithoutReplacement(possible_instruments, 4),
                      jsPsych.randomization.sampleWithoutReplacement(possible_instruments, 4),
                      jsPsych.randomization.sampleWithoutReplacement(possible_instruments, 4)]

    folders = ["audio/set0/output", "audio/set1/output", "audio/set2/output"]

    var song_order = [folders[song_order_options[condition][0]],
                      folders[song_order_options[condition][1]],
                      folders[song_order_options[condition][2]]]

    // console.log(song_order);
    // console.log(instr_order);

    var possible_wavs = [];

    var string = ""

    for (var i = 0; i < 12; i++) {
      var folder = song_order[i % 3];
      var eq_assignment = eq_assignments[i];
      var instr_assignment = instr_order[i % 3][Math.floor(i / 3)];
      var filePath = folder + "/" + eq_assignment + "/" + instr_assignment + ".wav";
      var num_instr = (possible_instruments.indexOf(instr_assignment) + 2);
      var correct_button = (possible_instruments.indexOf(instr_assignment) + 1);
      var song = song_order_options[condition][i % 3];

      if (eq_assignment == "mirrored_5dB" | eq_assignment == "mirrored_8dB") {
        variables = eq_assignment.split("_")
        var m1 = "mirrored"
        var m2 = "mirrored"
        var gain = variables[1];
      } else if (eq_assignment != "control"){
        variables = eq_assignment.split("_")
        var m1 = variables[0];
        var m2 = variables[1];
        var gain = variables[2];
      } else {
        var m1 = "control";
        var m2 = "control";
        var gain = "control";
      }

      // console.log(eq_assignment)
      // console.log("here " + gain)

      string += (i+1) + " EQ:" + eq_assignment + " Instrs:" + instr_assignment + " Song:" + (song+1) + "\n"

      possible_wavs.push({
      stimulus: filePath,
      eq_assignment: eq_assignment,
      instr_assignment: instr_assignment,
      num_instr: num_instr,
      correct_button: correct_button,
      song: song,
      folder: folder,
      m1: m1,
      m2: m2,
      gain: gain});
    }
    
    // console.log(possible_wavs)
    // console.log(string)


    var preload = {
      type: jsPsychPreload,
      auto_preload: true 
    };

    var welcome = {
      type: jsPsychHtmlKeyboardResponse, // interaction necessary to allow Chrome to play audio
      stimulus: `Welcome to the experiment!<br><br><b/>Please note that headphones are required for this experiment, and that background noise will make the task difficult.</b>
                <br>If you haven't done so already, please put on headphones and move to a quiet environment.<br><br>Then, press the space bar to begin.`,
      choices: " ",
      post_trial_gap: 500,
      // on_finish: console.log("2,3,1,1,2,3")
      };

    timeline.push(welcome);


// HEADPHONE CHECK
var headphones_intro = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `First, we'll go through a quick exercise to make sure you're wearing headphones.<br><br>
                Set your volume at 25%, then press the space bar to continue.`,
      choices: " ",
    }

    timeline.push(headphones_intro);


    var calibration_tone = {
      type: jsPsychAudioButtonResponse,
      stimulus: "headphone_check_files/norm_noise_calib_stim.wav",
      prompt: "<br>ðŸ”ˆ  ðŸ”‰  ðŸ”Š<br><br>Please adjust your volume so that the tone is playing at a comfortable volume.",
      choices: ["Replay tone", "Volume is good!"],
      response_allowed_while_playing: true,
      on_finish: function(data){
        // console.log(data.response)

        if (data.response == 1) {
          jsPsych.endCurrentTimeline()
          // console.log("Continuing.")
        }
      }
    }

    var ok_enough = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "Ok, that's enough!  Press the space bar to continue.",
      choices: " ",
    }

    var volume_calibration = {
      timeline: [calibration_tone, calibration_tone, calibration_tone, calibration_tone, ok_enough]
    }

    timeline.push(volume_calibration);

    var headphones_instr = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `In each of the following trials, you will hear three sounds separated by silence.<br><br>
                  <b/>Your task is to judge which sound was the SOFTEST - 1, 2, or 3.</b><br><br>
                  Please note that test sounds will only play once.<br><br>
                  Press the space bar to continue.`,
      choices: " ",
    }

    timeline.push(headphones_instr);

    var headphone_audio = [
      { stimulus: "headphone_check_files/norm_antiphase_HC_ISO.wav", correct_response: 1},
      { stimulus: "headphone_check_files/norm_antiphase_HC_IOS.wav", correct_response: 2},
      { stimulus: "headphone_check_files/norm_antiphase_HC_SOI.wav", correct_response: 0},
      { stimulus: "headphone_check_files/norm_antiphase_HC_SIO.wav", correct_response: 0},
      { stimulus: "headphone_check_files/norm_antiphase_HC_OSI.wav", correct_response: 1},
      { stimulus: "headphone_check_files/norm_antiphase_HC_OIS.wav", correct_response: 2}
    ];

    var test = {
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      prompt: "<br>Which tone was the softest?",
      choices: ['First', 'Second', 'Third'],
      response_allowed_while_playing: true,
      data: {
        task: 'headphone_check',
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      on_finish: function(data){
        data.correct = (data.response === data.correct_response);
        // console.log(data.correct);
        jsPsych.setProgressBar(jsPsych.getProgressBarCompleted() + 0.166667);
      }
    }

    var headphone_check = {
      timeline: [test],
      timeline_variables: headphone_audio,
      randomize_order: false,
      // randomize_order: true,
    };

    timeline.push(headphone_check);

    var headphone_eval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        var trials = jsPsych.data.get().filter({task: 'headphone_check'});
        var correct_trials = trials.filter({correct: true});
        if (correct_trials.count() > 4)
          return `<p>Great!  You passed the headphone check.<br><br>
                    Press the space bar to continue.`
        else
        return"<p>You didn't pass the headphone check.</p>";
      },
      on_start: function(data){
        jsPsych.setProgressBar(100);
      },
      on_finish: function(){
        var trials = jsPsych.data.get().filter({task: 'headphone_check'});
        var correct_trials = trials.filter({correct: true});
        if (correct_trials.count() < 5){
          jsPsych.endExperiment('Because you failed the headphone check, you have been disqualified from participating in this experiment.<br><br>You may now close this window.');
          window.location = "https://app.prolific.com/submissions/complete?cc=CMQ4EB78";
        } else {
          jsPsych.setProgressBar(0);
        }}
    };
    
    timeline.push(headphone_eval);

// TRIALS

  var experiment_instr = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `Now, it's time for the experiment.<br><br>
                    In each of the following trials, you will hear an audio track that consists of one or more musicians, each
                    playing a single instrument.<br><br>
                    <b/>Your task is to report how many musicians you hear playing.</b><br><br>
                    Each track will only play once!<br><br>
                    Press the space bar to continue.`,
        choices: " ",
      }

    timeline.push(experiment_instr);

  var trial = {
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      prompt: "<br>How many musicians are playing?",
      choices: ['One', 'Two', 'Three', 'Four', 'Five', 'Six'],
      response_allowed_while_playing: true,
      data: {
        correct_button_response: jsPsych.timelineVariable('correct_button'),
        num_instr: jsPsych.timelineVariable('num_instr'),
        task: 'trials',
        stimulus: jsPsych.timelineVariable('stimulus'),
        eq_assignment: jsPsych.timelineVariable('eq_assignment'),
        instr_assignment: jsPsych.timelineVariable('instr_assignment'),
        song: jsPsych.timelineVariable('song'),
        m1: jsPsych.timelineVariable('m1'),
        m2: jsPsych.timelineVariable('m2'),
        gain: jsPsych.timelineVariable('gain')
      },
      on_finish: function(data){
        jsPsych.setProgressBar(jsPsych.getProgressBarCompleted() + 0.083333);
      }
    }

  var trials = {
    timeline: [trial],
    timeline_variables: possible_wavs,
    randomize_order: false
  };

  timeline.push(trials);

  // POST QUESTION

  var post_instr = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `Thank you!  We have one more task for you.<br><br>
                  Each of the following pairs of audio clips contain two instruments playing.<br><br>
                  <b>Your task is to choose in which clip you can more clearly hear that there are two instruments playing.</b><br><br>
                  Ready?  Press the space bar to continue. `,
        choices: " ",
        on_finish: function(data){
        jsPsych.setProgressBar(0);
      }
      }

    timeline.push(post_instr);

    var post_question = {
      timeline: [
        { 
          type: jsPsychHtmlButtonResponse,
          stimulus: function() {
            // HTML for audio players and buttons
            var html = '<div>';            
            // Text prompt
            html += '<p>Please listen to these two audio mixes:</p>';
            // Audio player 1
            html += '<audio controls id="audio1"><source src="' + jsPsych.timelineVariable('audioFileA') + '" type="audio/mpeg"></audio>';
            // Audio player 2
            html += '<audio controls id="audio2"><source src="' + jsPsych.timelineVariable('audioFileB') + '" type="audio/mpeg"></audio>';
            html += '<p>And select in which file you can more clearly hear two instruments playing.</p>';
            html += '</div>';
            return html;
          },
          choices: ['Mix 1', 'Mix 2'],
          data: {
            audioFileA: jsPsych.timelineVariable('audioFileA'),
            audioFileB: jsPsych.timelineVariable('audioFileB'),
            equalized: jsPsych.timelineVariable('equalized')},
          on_finish: function(data){
            jsPsych.setProgressBar(jsPsych.getProgressBarCompleted() + 0.333333);
          }
      }
    ],
      timeline_variables: [
      { audioFileA: 'audio/set0/output/control/2_two_instr_norm.wav', audioFileB: 'audio/set0/output/mirrored_8dB/2_two_instr_norm.wav', equalized: 1},
      { audioFileA: 'audio/set1/output/mirrored_8dB/2_two_instr_norm.wav', audioFileB: 'audio/set1/output/control/2_two_instr_norm.wav', equalized: 0},
      { audioFileA: 'audio/set2/output/control/2_two_instr_norm.wav', audioFileB: 'audio/set2/output/mirrored_8dB/2_two_instr_norm.wav', equalized: 1},
      ],
      randomize_order: true,
      };
    
  timeline.push(post_question);

  var thank_you = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `Thank you!`,
        choices: " ",
      }

    timeline.push(thank_you);

  const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "REPLACE",
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };

    timeline.push(save_data);

  jsPsych.run(timeline);
  </script>
</html>