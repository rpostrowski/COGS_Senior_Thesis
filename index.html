<!DOCTYPE html>
<html>
  <head>
    <title>Rachel's Senior Thesis</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <link rel="stylesheet" href="style.css" type="text/css">
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" type="image/png" href="VC_logo.png"/>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.3"></script>
  </head>
  <body>
    <div id="header">
      <div id="logo-wrapper">
        <img src="VC_logo.png" alt="Vassar Logo" id="vclogo">
        <h3 id="logotext">Vassar College Cognitive Science</h3>
      </div>
    </div>
    <div id="jspsych-target"></div>
  </body>
  <script>

    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      on_finish: function() {
        // Display data
        jsPsych.data.displayData();
        window.location = "https://app.prolific.co/submissions/complete?cc=C1AW14RU";
      }
    });

    // Capture info from Prolific
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

    // DataPipe info
    const filename = `${subject_id}.csv`;

    jsPsych.data.addProperties({
      subject_id: subject_id,
      study_id: study_id,
      session_id: session_id
    });


    const condition = 6; // = await jsPsychPipe.getCondition(experiment_id)

    var timeline = [];

  // CONDITION ASSIGNMENTS
    var possible_alignments = ['control',
                              'm1cut_m2boost_3dB_q0', 'm1cut_m2boost_3dB_q1',
                              'm1cut_m2boost_7dB_q0', 'm1cut_m2boost_7dB_q1',
                              'm1cut_m2control_3dB_q0', 'm1cut_m2control_3dB_q1',
                              'm1cut_m2control_7dB_q0', 'm1cut_m2control_7dB_q1',
                              'm1boost_m2cut_3dB_q0', 'm1boost_m2cut_3dB_q1',
                              'm1boost_m2cut_7dB_q0', 'm1boost_m2cut_7dB_q1',
                              'm1boost_m2control_3dB_q0', 'm1boost_m2control_3dB_q1',
                              'm1boost_m2control_7dB_q0', 'm1boost_m2control_7dB_q1',
                              'm1control_m2cut_3dB_q0', 'm1control_m2cut_3dB_q1',
                              'm1control_m2cut_7dB_q0', 'm1control_m2cut_7dB_q1',
                              'm1control_m2boost_3dB_q0', 'm1control_m2boost_3dB_q1',
                              'm1control_m2boost_7dB_q0', 'm1control_m2boost_7dB_q1'];

    var possible_instruments = ["two_instr_norm", "one_extra_norm", "two_extra_norm"]

    // var possible_instruments = ["two_instr_norm", "two_instr_norm", "two_instr_norm",
    //                             "one_extra_norm", "one_extra_norm", "one_extra_norm",
    //                             "two_extra_norm", "two_extra_norm", "two_extra_norm"]


    // should extra switch??  also be 3 instrument includes extra1, or 50% 3 instr include extra2?
    // should be equal 3, 3, 3 of 2 instr, 3 instr, and 4 instr?

    var eq_assignments = jsPsych.randomization.sampleWithReplacement(possible_alignments, 9)
    var instr_assignments = jsPsych.randomization.sampleWithReplacement(possible_instruments, 9)

    folders = ["audio/set0/output", "audio/set1/output", "audio/set2/output"]

    var possible_wavs = [];

    for (var i = 0; i < 9; i++) {
      var folder = folders[i % 3];
      var eq_assignment = eq_assignments[i];
      var instr_assignment = instr_assignments[i];
      var filePath = folder + "/" + eq_assignment + "/" + instr_assignment + ".wav";
      var num_instr = (possible_instruments.indexOf(instr_assignment) + 2)
      var correct_button = (possible_instruments.indexOf(instr_assignment) + 1)

      if (eq_assignment != "control"){
        variables = eq_assignment.split("_")
        var m1 = variables[0];
        var m2 = variables[1];
        var gain = variables[2];
        var qval = variables[3];
      } else {
        var m1 = "control";
        var m2 = "control";
        var gain = "control";
        var qval = "control";
      }

      possible_wavs.push({
      stimulus: filePath,
      eq_assignment: eq_assignment,
      instr_assignment: instr_assignment,
      num_instr: num_instr,
      correct_button: correct_button,
      set: i % 3,
      m1: m1,
      m2: m2,
      gain: gain,
      qval: qval });
    }
    
    console.log(possible_wavs)

    var preload = {
      type: jsPsychPreload,
      auto_preload: true 
    };

    var welcome = {
      type: jsPsychHtmlKeyboardResponse, // interaction necessary to allow Chrome to play audio
      stimulus: `Welcome to the experiment!<br><br><b/>Please note that headphones are required for this experiment.
                If you haven't done so already, please put them on.</b><br><br>Then, press the space bar to begin.`,
      choices: " ",
      post_trial_gap: 500,
      on_finish: console.log("2,3,1,1,2,3")
      };

    timeline.push(welcome);

// HEADPHONE CHECK
    var calibration_tone = {
      type: jsPsychAudioButtonResponse,
      stimulus: "headphone_check_files/noise_calib_stim.wav",
      prompt: "<br>ðŸ”ˆ  ðŸ”‰  ðŸ”Š<br><br>Please adjust your volume so that the tone is playing at a comfortable loudness.",
      choices: ["Replay tone", "Volume is good!"],
      response_allowed_while_playing: false,
      on_finish: function(data){
        console.log(data.response)

        if (data.response == 1) {
          jsPsych.endCurrentTimeline()
          console.log("Continuing.")
        }
      }
    }

    var ok_enough = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "Ok, that's enough!  Press the space bar to continue.",
      choices: " ",
    }

    var volume_calibration = {
      timeline: [calibration_tone, calibration_tone, calibration_tone, calibration_tone, ok_enough]
    }

    timeline.push(volume_calibration);

    var headphones_intro = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `Great!  Now, we'll go through a quick exercise to make sure you're wearing headphones.<br><br>
                Press the space bar to continue.`,
      choices: " ",
    }

    timeline.push(headphones_intro);

    var headphones_instr = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `In each of the following trials, you will hear three sounds separated by silence.<br><br>
                  <b/>Simply judge which sound was the SOFTEST - 1, 2, or 3.</b><br><br>
                  Test sounds will only play once!<br><br>
                  Press the space bar to continue.`,
      choices: " ",
    }

    timeline.push(headphones_instr);

    var headphone_audio = [
      { stimulus: "headphone_check_files/norm_antiphase_HC_ISO.wav", correct_response: 1},
      { stimulus: "headphone_check_files/norm_antiphase_HC_IOS.wav", correct_response: 2},
      { stimulus: "headphone_check_files/norm_antiphase_HC_SOI.wav", correct_response: 0},
      { stimulus: "headphone_check_files/norm_antiphase_HC_SIO.wav", correct_response: 0},
      { stimulus: "headphone_check_files/norm_antiphase_HC_OSI.wav", correct_response: 1},
      { stimulus: "headphone_check_files/norm_antiphase_HC_OIS.wav", correct_response: 2}
    ];

    var test = {
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      prompt: "<br>Which tone was the softest?",
      choices: ['First', 'Second', 'Third'],
      // response_allowed_while_playing: false,
      response_allowed_while_playing: true,
      data: {
        task: 'headphone_check',
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      on_finish: function(data){
        data.correct = (data.response === data.correct_response);
        console.log(data.correct);
      }
    }

    var headphone_check = {
      timeline: [test],
      timeline_variables: headphone_audio,
      randomize_order: false,
      // randomize_order: true,
    };

    timeline.push(headphone_check);

    var headphone_eval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {

        var trials = jsPsych.data.get().filter({task: 'headphone_check'});
        var correct_trials = trials.filter({correct: true});
        if (correct_trials.count() > 4)
          return `<p>Great!  You passed the headphone check.</p>`
        else
        return"<p>You didn't pass the headphone check.</p>";
      },
      on_finish: function(){
        var trials = jsPsych.data.get().filter({task: 'headphone_check'});
        var correct_trials = trials.filter({correct: true});
        if (correct_trials.count() < 5)
          jsPsych.endExperiment('Because you failed the headphone check, you have been disqualified from participating in this experiment.<br><br>You may now close this window.');
        }
    };
    
    timeline.push(headphone_eval);

// TRIALS

  var experiment_instr = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `Now, it's time for the experiment.<br><br>
                    In each of the following trials, you will hear an audio track that consists of multiple instruments.<br><br>
                    <b/>Your task is to guess how many instruments are playing.</b><br><br>
                    Test sounds will only play once!<br><br>
                    Press the space bar to continue.`,
        choices: " ",
      }

    timeline.push(experiment_instr);

  var trial = {
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      prompt: "<br>How many instruments are playing?",
      choices: ['One', 'Two', 'Three', 'Four', 'Five'],
      // response_allowed_while_playing: false,
      response_allowed_while_playing: true,
      data: {
        correct_button_response: jsPsych.timelineVariable('correct_button'),
        num_instr: jsPsych.timelineVariable('num_instr'),
        task: 'trials',
        stimulus: jsPsych.timelineVariable('stimulus'),
        eq_assignment: jsPsych.timelineVariable('eq_assignment'),
        instr_assignment: jsPsych.timelineVariable('instr_assignment'),
        set: jsPsych.timelineVariable('set'),
        m1: jsPsych.timelineVariable('m1'),
        m2: jsPsych.timelineVariable('m2'),
        gain: jsPsych.timelineVariable('gain'),
        qval: jsPsych.timelineVariable('qval'),
      },
    }

  var trials = {
    timeline: [trial],
    timeline_variables: possible_wavs,
    randomize_order: true,
  };

  timeline.push(trials);

  const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "REPLACE",
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };

    timeline.push(save_data);

  jsPsych.run(timeline);
  </script>
</html>