<!DOCTYPE html>
<html>
  <head>
    <title>Senior Thesis Demo</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-audio-button-response.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    
  </head>
  <body></body>
  <script>

    const jsPsych = initJsPsych();
    var timeline = [];


// CONDITION ASSIGNMENTS
    var possible_alignments = ['control',
                              'm1cut_m2boost_3dB_q0', 'm1cut_m2boost_3dB_q1',
                              'm1cut_m2boost_7dB_q0', 'm1cut_m2boost_7dB_q1',
                              'm1cut_m2control_3dB_q0', 'm1cut_m2control_3dB_q1',
                              'm1cut_m2control_7dB_q0', 'm1cut_m2control_7dB_q1',
                              'm1boost_m2cut_3dB_q0', 'm1boost_m2cut_3dB_q1',
                              'm1boost_m2cut_7dB_q0', 'm1boost_m2cut_7dB_q1',
                              'm1boost_m2control_3dB_q0', 'm1boost_m2control_3dB_q1',
                              'm1boost_m2control_7dB_q0', 'm1boost_m2control_7dB_q1',
                              'm1control_m2cut_3dB_q0', 'm1control_m2cut_3dB_q1',
                              'm1control_m2cut_7dB_q0', 'm1control_m2cut_7dB_q1',
                              'm1control_m2boost_3dB_q0', 'm1control_m2boost_3dB_q1',
                              'm1control_m2boost_7dB_q0', 'm1control_m2boost_7dB_q1'];

    // should extra switch??  also be 3 instrument includes extra1, or 50% 3 instr include extra2?

    var assignments = jsPsych.randomization.sampleWithReplacement(possible_alignments, 9)

    var assignment_info_object = {
        'set0_2inst': assignments[0],
        'set0_3inst': assignments[1],
        'set0_4inst': assignments[2],
        'set1_2inst': assignments[3],
        'set1_3inst': assignments[4],
        'set1_4inst': assignments[5],
        'set2_2inst': assignments[6],
        'set2_3inst': assignments[7],
        'set2_4inst': assignments[8],
      };

    var preload = {
      type: jsPsychPreload,
      auto_preload: true 
    };

    var welcome = {
      type: jsPsychHtmlKeyboardResponse, // interaction necessary to allow Chrome to play audio
      stimulus: "Welcome to the experiment. Press the space bar to begin.",
      choices: " ",
      post_trial_gap: 500,
      on_finish: console.log("2,3,1,1,2,3")
      };

    timeline.push(welcome);

// HEADPHONE CHECK
    var calibration_tone = {
      type: jsPsychAudioButtonResponse,
      stimulus: "headphone_check_files/noise_calib_stim.wav",
      prompt: "<br>Please adjust your volume so that the tone is playing at a comfortable loudness.",
      choices: ["Replay", "Continue"],
      response_allowed_while_playing: false,
      on_finish: function(data){
        console.log(data.response)

        if (data.response == 1) {
          jsPsych.endCurrentTimeline()
          console.log("Continuing.")
        }
      }
    }

    var ok_enough = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "That's enough.  Press the space bar to continue.",
      choices: " ",
    }

    var volume_calibration = {
      timeline: [calibration_tone, calibration_tone, calibration_tone, calibration_tone, ok_enough]
    }

    timeline.push(volume_calibration);

    var headphones_instr = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `When you hit Play, you will hear three sounds separated by silences.<br><br>
                  Simply judge WHICH SOUND WAS SOFTEST (quietest) -- 1, 2, or 3?<br><br>
                  Test sounds will only play once!<br><br>
                  Press the space bar to continue.`,
      choices: " ",
    }

    timeline.push(headphones_instr);

    var headphone_audio = [
      { stimulus: "headphone_check_files/antiphase_HC_ISO.wav", correct_response: 1},
      { stimulus: "headphone_check_files/antiphase_HC_IOS.wav", correct_response: 2},
      { stimulus: "headphone_check_files/antiphase_HC_SOI.wav", correct_response: 0},
      { stimulus: "headphone_check_files/antiphase_HC_SIO.wav", correct_response: 0},
      { stimulus: "headphone_check_files/antiphase_HC_OSI.wav", correct_response: 1},
      { stimulus: "headphone_check_files/antiphase_HC_OIS.wav", correct_response: 2}
    ];

    var test = {
      type: jsPsychAudioButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      prompt: "<br>Which was the softest?",
      choices: ['First', 'Second', 'Third'],
      response_allowed_while_playing: false,
      data: {
        task: 'headphone_check',
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      on_start: function(data){
        // console.log(jsPsych.timelineVariable('correct_response'))
      },
      on_finish: function(data){
        // console.log(data.correct_response)
        data.correct = (data.response === data.correct_response);
        console.log(data.correct);
      }
    }

    var headphone_check = {
      timeline: [test],
      timeline_variables: headphone_audio,
      randomize_order: false,
      // randomize_order: true,
    };

    timeline.push(headphone_check);

    var headphone_eval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {

        var trials = jsPsych.data.get().filter({task: 'headphone_check'});
        var correct_trials = trials.filter({correct: true});
        if (correct_trials.count() > 5)
          return `<p>You passed the headphone check.</p>`
        else
          return `<p>You didn't pass the headphone check.</p>`
      }
    };
    
    timeline.push(headphone_eval);

// TRIALS
  for (var i = 0; i < assignments.length; i++) {
      var trial = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: assignments[i],
          choices: " ",
      };
      console.log("new")
      timeline.push(trial);
  }

    jsPsych.run(timeline);
  </script>
</html>